<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPAM Analytics - D√©penses Sant√©</title>
    <link rel="stylesheet" href="assets/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-logo">CPAM Analytics</h1>
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link">Accueil</a></li>
                <li><a href="depenses.html" class="nav-link active">D√©penses Sant√©</a></li>
                <li><a href="actes.html" class="nav-link">Actes M√©dicaux</a></li>
                <li><a href="prevision.html" class="nav-link">Pr√©visions</a></li>
                <li><a href="fraudes.html" class="nav-link">D√©tection Fraudes</a></li>
                <li><a href="api.html" class="nav-link">API Analytics</a></li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <h1>üè• Analyse des D√©penses de Sant√©</h1>
            <p>Explorez les donn√©es en temps r√©el avec des analyses interactives Python/R</p>
        </div>

        <div class="controls-panel">
            <h3>üîß Contr√¥les d'Analyse</h3>
            <div class="analysis-container">
                <div>
                    <div class="control-group">
                        <label for="periode">P√©riode d'analyse:</label>
                        <select id="periode">
                            <option value="2023">2023</option>
                            <option value="2022-2023">2022-2023</option>
                            <option value="2021-2023">2021-2023</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label for="region">R√©gion:</label>
                        <select id="region">
                            <option value="france">France enti√®re</option>
                            <option value="alsace">Alsace</option>
                            <option value="bretagne">Bretagne</option>
                            <option value="paca">PACA</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label for="type-analyse">Type d'analyse:</label>
                        <select id="type-analyse">
                            <option value="descriptive">Statistiques descriptives</option>
                            <option value="correlation">Analyse de corr√©lation</option>
                            <option value="regression">R√©gression lin√©aire</option>
                            <option value="clustering">Classification K-means</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="runPythonAnalysis()">üêç Analyser avec Python</button>
                        <button class="btn btn-secondary" onclick="runRAnalysis()">üìä Analyser avec R</button>
                        <button class="btn btn-warning" onclick="updateRealTime()">üîÑ Actualiser Donn√©es</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Param√®tres avanc√©s:</label>
                        <input type="range" id="seuil-significance" min="0.01" max="0.1" step="0.01" value="0.05">
                        <small>Seuil de significativit√©: <span id="seuil-value">0.05</span></small>
                    </div>
                </div>
            </div>
        </div>

        <div class="analysis-container">
            <div class="chart-container">
                <h3>üìà Visualisation Interactive</h3>
                <div id="main-chart" style="height: 400px;"></div>
            </div>
            
            <div class="chart-container">
                <h3>üéØ Analyse Statistique</h3>
                <div id="stats-chart" style="height: 400px;"></div>
            </div>
        </div>

        <div class="chart-container">
            <h3>üíª Sortie des Scripts</h3>
            <div id="script-output" class="script-output">
Pr√™t √† ex√©cuter des analyses...
            </div>
        </div>
    </main>

    <script src="assets/main.js"></script>
    <script>
        // Scripts sp√©cifiques √† la page d√©penses
        let mainChart, statsChart;

        document.addEventListener('DOMContentLoaded', function() {
            initializeDepensesPage();
            
            // √âv√©nements
            document.getElementById('seuil-significance').addEventListener('input', function() {
                document.getElementById('seuil-value').textContent = this.value;
            });
        });

        function initializeDepensesPage() {
            // Graphique principal avec Plotly
            const mainData = [{
                x: ['Consultations', 'M√©dicaments', 'Hospitalisations', 'Soins dentaires', 'Optique'],
                y: [12000, 9500, 15000, 3000, 2000],
                type: 'bar',
                marker: {
                    color: ['#0055a4', '#0077c2', '#0099e5', '#00bbf1', '#00ddff']
                }
            }];

            const mainLayout = {
                title: 'R√©partition des D√©penses de Sant√© 2023',
                xaxis: { title: 'Cat√©gories' },
                yaxis: { title: 'D√©penses (M‚Ç¨)' }
            };

            Plotly.newPlot('main-chart', mainData, mainLayout);

            // Graphique statistique
            loadEvolutionChart();
        }

        async function loadEvolutionChart() {
            try {
                const data = await window.cpamAnalytics.loadCSVData('evolution_depenses_detaillee.csv');
                if (data) {
                    const trace = {
                        x: data.data.map(row => row.Annee),
                        y: data.data.map(row => parseInt(row.Depenses_Totales)),
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: '√âvolution'
                    };

                    const layout = {
                        title: '√âvolution Temporelle des D√©penses',
                        xaxis: { title: 'Ann√©e' },
                        yaxis: { title: 'D√©penses Totales (M‚Ç¨)' }
                    };

                    Plotly.newPlot('stats-chart', [trace], layout);
                }
            } catch (error) {
                console.error('Erreur chargement donn√©es:', error);
            }
        }

        async function runPythonAnalysis() {
            const output = document.getElementById('script-output');
            output.textContent = 'Ex√©cution du script Python...\n';

            const periode = document.getElementById('periode').value;
            const region = document.getElementById('region').value;
            const typeAnalyse = document.getElementById('type-analyse').value;

            // Simulation d'ex√©cution Python
            setTimeout(() => {
                const result = generatePythonOutput(periode, region, typeAnalyse);
                output.textContent = result;
            }, 2000);
        }

        async function runRAnalysis() {
            const output = document.getElementById('script-output');
            output.textContent = 'Ex√©cution du script R...\n';

            const periode = document.getElementById('periode').value;
            const region = document.getElementById('region').value;

            // Simulation d'ex√©cution R
            setTimeout(() => {
                const result = generateROutput(periode, region);
                output.textContent = result;
            }, 2000);
        }

        function generatePythonOutput(periode, region, typeAnalyse) {
            return `üêç ANALYSE PYTHON - ${typeAnalyse.toUpperCase()}
P√©riode: ${periode}
R√©gion: ${region}

=== R√âSULTATS ===
Donn√©es charg√©es: 5 cat√©gories, ${periode === '2023' ? '1 ann√©e' : '3 ann√©es'}
Budget total analys√©: 41,500 M‚Ç¨

Statistiques descriptives:
- Moyenne: 8,300 M‚Ç¨
- M√©diane: 9,500 M‚Ç¨
- √âcart-type: 5,244 M‚Ç¨
- CV: 63.2%

${typeAnalyse === 'correlation' ? `
Corr√©lations significatives (p < 0.05):
- Hospitalisations vs Population: r = 0.78 (p = 0.023)
- M√©dicaments vs √Çge moyen: r = 0.65 (p = 0.041)
` : ''}

${typeAnalyse === 'regression' ? `
Mod√®le de r√©gression lin√©aire:
R¬≤ = 0.84
RMSE = 1,234 M‚Ç¨
Coefficients significatifs: 3/5
` : ''}

${typeAnalyse === 'clustering' ? `
Classification K-means (k=3):
Cluster 1: D√©penses √©lev√©es (Hospitalisations)
Cluster 2: D√©penses moyennes (Consultations, M√©dicaments)
Cluster 3: D√©penses faibles (Dentaire, Optique)
Silhouette score: 0.73
` : ''}

‚úÖ Analyse termin√©e avec succ√®s
Temps d'ex√©cution: 1.23s`;
        }

        function generateROutput(periode, region) {
            return `üìä ANALYSE R - STATISTIQUES AVANC√âES
P√©riode: ${periode}
R√©gion: ${region}

> library(dplyr)
> library(ggplot2)
> library(corrplot)

=== CHARGEMENT DES DONN√âES ===
Lecture fichier: depenses_sante_france.csv
Dimensions: 5 observations x 2 variables

=== ANALYSE STATISTIQUE ===
summary(depenses):
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   2000    3000    9500    8300   12000   15000 

Test de normalit√© (Shapiro-Wilk):
W = 0.8521, p-value = 0.1847
Distribution normale accept√©e (p > 0.05)

=== ANALYSE DE VARIANCE ===
ANOVA one-way:
                Df Sum Sq Mean Sq F value Pr(>F)
Cat√©gories       4  2.1e+08  5.3e+07   4.23  0.041 *
Residuals       15  1.9e+08  1.3e+07
---
Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

=== RECOMMANDATIONS ===
‚Ä¢ Diff√©rences significatives entre cat√©gories (p = 0.041)
‚Ä¢ Focus sur les hospitalisations (variance √©lev√©e)
‚Ä¢ Surveillance des tendances saisonni√®res recommand√©e

Call: lm(formula = depenses ~ categorie)
Multiple R-squared: 0.529, Adjusted R-squared: 0.403
F-statistic: 4.23 on 4 and 15 DF, p-value: 0.041

‚úÖ Analyse R termin√©e`;
        }

        function updateRealTime() {
            const output = document.getElementById('script-output');
            output.textContent = 'üîÑ Actualisation des donn√©es en cours...\n';
            
            setTimeout(() => {
                output.textContent += 'Connexion √† l\'API CPAM...\n';
                output.textContent += 'R√©cup√©ration des donn√©es temps r√©el...\n';
                output.textContent += 'Mise √† jour des graphiques...\n';
                output.textContent += '‚úÖ Donn√©es actualis√©es avec succ√®s';
                
                // Actualise les graphiques
                loadEvolutionChart();
            }, 1500);
        }
    </script>
</body>
</html>
